{% extends 'base.html' %}
{% load static %}
{% load bootstrap3 %}
{% block usuario %}
						<p id="usuario_logueado"  > 
							<strong>Usuario:</strong> {{user_2.user.username}}
							&nbsp; / &nbsp;
							<strong>Perfil:</strong> {{user_2.perfil}}
							&nbsp; / &nbsp;
							<strong>Sucursal:</strong> {{user_2.sucursal}}
							&nbsp; / &nbsp;
							<strong>Caja:</strong> {{c}}
						</p>
{% endblock  %}

{% block content %}

	<div class="col-xs-12 cls_encabezado_body">
		<a>
			Nuevo Empeño
		</a>		
	</div>
	<div class="col-xs-12">
		<div  class="cls_form_1">	
			<div class="row cls_form_consulta">
				<div class="col-xs-12">
					<div class="panel panel-default">						
						<div class="panel-body">
							<div clasS="col-xs-12">
								<div class="panel panel-default">						
									<div class="panel-body">
										<div class="row">
											<div class="col-xs-12">
												<div class="col-xs-6">
													
												</div>
												<div class="col-xs-3">
													<a class="btn btn-default" id="btn_nva_cotizacion">
															Limpiar Cotización
														</a>
												</div>
												<div class="col-xs-3 text-right">
														<a class="btn btn-primary" id="btn_agregar_producto">
															Agregar Producto
														</a>
												</div>
											</div>
											
										</div>
										<div class="row">
												<div class="col-xs-12">
													<h3 class="page-header">
														Productos en cotización
													</h3>	
												</div>
											</div>
											<div class="row">
												<div class="col-xs-12">
													<table id="tabla_cotizacion" class="table table-bordered">
												    <thead>
												      <tr>
												      	<th></th>
												        <th>Tipo Producto</th>
												        <th>Linea</th>
												        <th>SubLinea</th>
												        <th>Marca</th>
												        <th>Descripción</th>
												        <th>Kilataje</th>
												        <th>Peso</th>
												        <th>Avaluo</th>
												        <th>M Sugerido</th>
												        <th>Mutuo</th>
												      </tr>
												    </thead>
												    <tbody>
												     
												    </tbody>
												  </table>
												</div>
											</div>
											<div class="row">
												<div class="col-xs-12 text-right">
													<label>No. Movs: <span id="num_movs"></span> </label>
												</div>
											</div>
											<form method="post" action="#" class="cls_form_1">
												{%csrf_token%}
												<div class="row">
													<div class="col-xs-12">
														<h4 class="page-header">Plazo</h4>
													</div>
													<div class="col-xs-3">
															{%bootstrap_field form.plazo show_label=False%}
													</div>

												</div>
												<div class="row">
													<div class="col-xs-12">
														<h4 class="page-header">Cliente</h4>
													</div>
												
													<div class="col-xs-3">
															{%bootstrap_field form.cliente show_label=False%}
													</div>
													<div class="col-xs-3">
														<a class="btn btn-default" id="btn_buscar_cliente">Buscar Cliente</a>
													</div>
													
												</div>
												<div class="row">
													<div class="col-xs-12">
														<h4 class="page-header">Cotitular</h4>
													</div>
													<div class="col-xs-4">
														
															<label for=""> Nombre</label>					
															{%bootstrap_field form.nombre_cotitular show_label=False%}
														

													</div>
													<div class="col-xs-4">
														
															<label for=""> Nombre</label>					
															{%bootstrap_field form.apellido_paterno show_label=False%}
														

													</div>
													<div class="col-xs-4">
														
															<label for=""> Nombre</label>					
															{%bootstrap_field form.apellido_materno show_label=False%}
														

													</div>
												</div>

												<div class="row">
													<div class="col-xs-12">
														<h4 class="page-header">Resumen de Cotización</h4>
													</div>
													<div class="col-xs-6">
														<table class="table table-bordered">
														<thead>
														<tr>
														<th></th>
														<th>Oro</th>
														<th>Plata</th>
														<th>Varios</th>
														</tr>
														</thead>
														<tbody>
															<tr>
																<td><label>Avaluo</label></td>	
																<td><a id="id_avaluo_oro"></a></td>	
																<td><a id="id_avaluo_plata"></a></td>	
																<td><a id="id_avaluo_varios"></a></td>	
															</tr>
															<tr>
																<td><label>Mutuo</label></td>	
																<td><a id="id_mutuo_oro"></a></td>	
																<td><a id="id_mutuo_plata"></a></td>	
																<td><a id="id_mutuo_varios"></a></td>	
															</tr>
															<tr>
																<td><label>Refrendo</label></td>	
																<td><a id="id_refrendo_oro"></a></td>	
																<td><a id="id_refrendo_plata"></a></td>	
																<td><a id="id_refrendo_varios"></a></td>	
															</tr>
														</tbody>
														</table>
													</div>

													<div class="col-xs-6">
													</div>
												</div>
												<div class="row">
														<div class="col-xs-12 text-right">
															<button class="btn btn-primary">
																Terminar Empeño
															</button>
														</div>
												</div>
											</form>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>




	{% if msj_error != '' %}
		<div class="fondo_mensaje" >
			
		</div >
		<div class="mensaje" >
				
				<div class="panel panel-default">	
					<h3 class="page-header">{{msj_error}}</h3>
					<a class="btn btn-primary" href="{% url 'seguridad:admin_cajas' %}">Aceptar</a>
					<br>
					<br>

				</div>
		</div>
	{% endif %}


	<div class="cls_form_busca_cliente">		
			<div class="row">
				<div class="col-xs-12 " >
					<h4 class="page-header" style="text-align: center;">
						Busca Cliente
					</h4>
				</div>
				<div class="col-xs-6">
					<label for=""> Apellido o Nombre</label>					
					<input type="text" name="" id="id_cliente_nomapp" class="form-control">	
			
				</div>
				<div class="col-xs-3" style="text-align: center;">
					<label for="">&nbsp;</label>
					<a class="btn btn-default form-control" id="btn_filtrar_cliente">Buscar</a>
				</div>	

				<div class="col-xs-3" style="text-align: center;">
					<label for="">&nbsp;</label>
					<a class="btn btn-default form-control" id="btn_nuevo_cliente" href="{% url 'empenos:alta_cliente' %}" target="_blank">Cl Nvo</a>
				</div>	
				<div class="col-xs-12">
					<br>
					<br>
							<table id="tabla_cliente" class="table table-bordered">
								<thead>
								<tr>
									<th></th>
									<th>Cliente</th>
									
								</tr>
								</thead>
								<tbody>

								</tbody>
							</table>
				</div>
				<div class="col-xs-12">
					<div class="col-xs-6 " style="text-align: center;">
					
					</div>
					<div class="col-xs-6" style="text-align: center;">
						<br>
						<br>
							<a class="btn btn-primary" id="btn_cancelar_buscacliente">Cancelar</a>
					</div>	
				</div>
			</div>
	</div>	

	<div class="cls_form_emergente">
		
			<div class="row">
				<div class="col-xs-12 " >
					<h4 class="page-header" style="text-align: center;">
						Cotizar Producto
					</h4>
				</div>
				<div class="col-xs-12">
					<label for=""> Tipo Producto</label>					
					<select name="sucursal" class="form-control" title="" required="" id="id_tipo_producto">
					  
					</select>		
					<div class="help-block" id="id_error_tipo_producto">
						Debe indicar un tipo de producto.
					</div>				
				</div>
				<div class="col-xs-12">
					<label for="">Linea</label>					
					<select name="sucursal" class="form-control" title="" required="" id="id_linea">
					  
					</select>	
					<div class="help-block" id="id_error_linea">
						Debe indicar una linea valida.
					</div>				
				</div>
				<div class="col-xs-12">
					<label for="">Sub Linea</label>					
					<select name="sucursal" class="form-control" title="" required="" id="id_sublinea">
					  
					</select>	
					<div class="help-block" id="id_error_sublinea">
						Debe indicar una sublinea valida.
					</div>					
				</div>
				<div class="col-xs-12">
					<label for="">Marca</label>					
					<select name="sucursal" class="form-control" title="" required="" id="id_marca">
					  
					</select>	
					<div class="help-block" id="id_error_marca">
							Debe indicar una marca valida.
					</div>
				</div>
				<div class="col-xs-12">
					<label for="">Descripcion</label>					
					<input type="text" name="" id="id_descripcion" class="form-control" maxlength="50" >	
					<div class="help-block" id="id_error_descripcion">
							Debe indicar la descripcion del producto.
					</div>

				</div>

				<div class="col-xs-12">
					<label for="">Observaciónes</label>					
					<textarea id="txt_observaciones" name="textarea" rows="3" class="form-control" cols="50" placeholder="" maxlength="50"></textarea>					
				</div>

				<div class="col-xs-12">									
					<br>
					<div class="panel panel-default">						
						<div class="panel-body">
							<p>Solo para joyeria</p>
							<div class="col-xs-7">
								<label>Kilataje</label>
								<select name="kilataje" class="form-control" id="id_kilataje">
								
								</select>
							</div>	
							<div class="col-xs-5">
								<label>Peso (gr)</label>
								<input type="number" name="" id="id_peso" class="form-control">
								
							</div>

							
						</div>

					</div>
				</div>
				<div class="col-xs-6">
					<label>
						Avaluo
					</label>
					<input type="number" name="" id="id_avaluo" class="form-control">
					<div class="help-block" id="id_error_avaluo">
							El importe avaluo es incorrecto.
					</div>
				</div>
				<div class="col-xs-6">
					<label>
						Mutuo Sugerido
					</label>
					<input type="number" name="" id="id_mutuo_sugerido" class="form-control" readonly="true">
					<div class="help-block" id="id_error_mutuo_sugerido">
							El importe mutuo sugerido es incorrecto.
					</div>

				</div>
				<div class="col-xs-6">
					<label>
						Mutuo
					</label>
					<input type="number" name="" id="id_mutuo" class="form-control" >
					<div class="help-block" id="id_error_mutuo">
							El importe mutuo es incorrecto.
					</div>
					<div class="help-block" id="id_error_mutuo_2">
							El importe mutuo no puede ser mayor al mutuo sugerido
					</div>
				</div>
				<div class="col-xs-6">
					&nbsp;
				</div>
					<div class="col-xs-12">					
						<div class="help-block" id="id_error_general">
								Corrige los errores en el formulario y vuelve a intentarlo.
						</div>	
					</div>
				<div class="col-xs-12">
					<div class="col-xs-6 " style="text-align: center;">
						<br>
						<br>
						<a class="btn btn-primary" id="btn_agregar">Agregar</a>
					</div>
					<div class="col-xs-6" style="text-align: center;">
						<br>
						<br>
							<a class="btn btn-default" id="btn_cancelar">Cancelar</a>
					</div>	
				</div>
				
		
			</div>
	</div>


		<div class="fondo_mensaje_2 cls_msj_error" >
			
		</div >
		<div class="mensaje_2 cls_msj_error" >
				
				<div class="panel panel-default">	
					<h3 class="page-header" id="msj_error"></h3>
					<a class="btn btn-primary" id="btn_aceptar">Aceptar</a>
					<br>
					<br>

				</div>
		</div>

		<div class="fondo_mensaje_2 cls_confirma_eliminar" >
			
		</div >
		<div class="mensaje_2 cls_confirma_eliminar" >
				
				<div class="panel panel-default">	
					<h3 class="page-header">¿Desea eliminar el producto?</h3>
					<a class="btn btn-primary" id="btn_aceptar_eliminar">Aceptar</a>
					<a class="btn btn-primary" id="btn_cancelar_eliminar">Cancelar</a>
					<br>
					<br>

				</div>
		</div>


	<div class="fondo_mensaje"  id="fondo_form_emergente">
		
	</div >


<div id="fondo_preloader">
	<div class="preloader" id="preloader">
	
	</div>
</div>

<a id="imprimir_boleta" href="{%url 'empenos:imprime_boleta'%}">prueba</a>

	<script type="text/javascript">
			var mutuo_aux=0;
			var producto_eliminar=0;
		$(document).ready(
				function()
				{
					var empeno_exitoso="{{empeno_exitoso}}";
					if(empeno_exitoso==1)
					{							
					  url =$("#imprimir_boleta").attr("href");
				      window.open(url, '_blank');	
					}

					fn_inicio();

					if(empeno_exitoso==1)
					{
						$(".cls_msj_error").show();
						$("#msj_error").text("La boleta se genero correctamente.");

					}
					if(empeno_exitoso==0)
					{
						$(".cls_msj_error").show();
						$("#msj_error").text("El empeño NO se genero correctamente.");
					}
					if(empeno_exitoso==2)
					{
						$(".cls_msj_error").hide();
					}

//eventos Click
//**********************************************************************************************
//**********************************************************************************************
		$("#btn_nuevo_cliente").click(
					function()
					{
							$("#msj_error").text("Deberá recargar la pantalla para que los nuevos clientes sean mostrados.");

							

							$(".cls_msj_error").show();
					}
			);

			$("#btn_buscar_cliente").click(
					function()
					{
						$(".cls_form_busca_cliente").show();
						$("#fondo_form_emergente").show();
					}
				);
			$("#btn_filtrar_cliente").click(
					function()
					{
						fn_busca_cliente();
					}
				);
			$("#btn_cancelar_buscacliente").click(
						function()
						{
							$(".cls_form_busca_cliente").hide();		
							$("#fondo_form_emergente").hide();
						}
				);
				$("#btn_agregar_producto").click(
						function()
						{
							fn_carga_tipo_producto();
						}
					);

				$("#btn_aceptar").click(
						function()
						{
							$(".cls_msj_error").hide();
						}
					);
				$("#id_tipo_producto").change(
						function()
						{
							fn_oculta_errores();

							fn_carga_linea($("#id_tipo_producto").val());

							$('#id_kilataje').empty();
							$("#id_peso").val("0");
							$("#id_avaluo").val("0");
							$("#id_mutuo_sugerido").val("0");
							$("#id_mutuo").val("0");
							//si es oro o plata
							if ($("#id_tipo_producto").val()=="1" || $("#id_tipo_producto").val()=="2")
							{
								$("#id_kilataje,#id_peso").prop("disabled",false);
								fn_carga_kilataje( $("#id_tipo_producto").val());	
								$("#id_avaluo").prop("disabled",true);
								$("#txt_observaciones").prop("readonly",true)

								
							}
							else
							{
								$("#id_avaluo").prop("disabled",false);
								$("#id_avaluo").prop("readonly",false);
								$("#id_kilataje,#id_peso").prop("disabled",true);								
								$("#txt_observaciones").prop("readonly",false)
							}

							$("#txt_observaciones").val("");														

						}
					);

				$("#id_linea").change(
						function()
						{
							fn_carga_sublinea($("#id_linea").val());
						}
					);
				$("#id_sublinea").change(
						function()
						{
							fn_carga_marca();
						}
					);
				$("#id_kilataje").change(
						function()
						{
							mutuo_aux=0;
							fn_calcula_totales();

						}
					);
				$("#id_peso").change(
					function()
					{
						mutuo_aux=0;
						fn_calcula_totales();
					}
				);

				$("#btn_agregar").click(
					function()
					{
						mutuo_aux=$("#id_mutuo").val();
						fn_calcula_totales();
						var estatus=fn_valida_form_cotizacion();

						//si estatus es 1 es que todo salio correcto.
						if(estatus=="1")
						{
							fn_guarda_cotizacion();
						}
					}
				);

				$("#id_avaluo").change(
						function()
						{
							
							mutuo_aux=0;
							fn_calcula_totales();
							
						}
					);
				$("#id_plazo").change(
						function()
						{
							fn_consulta_cotizacion();
						}
					);
				$("#btn_aceptar_eliminar").click(
						function()
						{
							fn_confirma_eliminar_producto();
							producto_eliminar=0;
							$(".cls_confirma_eliminar").hide();
						}
					);
				$("#btn_cancelar_eliminar").click(
						function ()
						{
							producto_eliminar=0;
							$(".cls_confirma_eliminar").hide();
						}
					);
				$("#btn_cancelar").click(
						function()
						{

							$(".cls_form_emergente").hide();
							$("#fondo_form_emergente").hide();
						}
					);
				$("#fondo_form_emergente").click(
						function()
						{
						
							$(".cls_form_emergente").hide();
							$("#fondo_form_emergente").hide();	
						}
					);
				$("#btn_nva_cotizacion").click(
						function()
						{
							fn_nueva_cotizacion();
						}
					);

//**********************************************************************************************
//**********************************************************************************************


				


//**********************************************************************************************
//**********************************************************************************************
				}
			);

//funciones
//**********************************************************************************************
//**********************************************************************************************
			function fn_inicio()
			{
				$("#fondo_form_emergente").hide();
				$(".cls_form_emergente").hide();
				$(".cls_msj_error").hide();
				$("#fondo_preloader").hide();
				$(".cls_confirma_eliminar").hide();
				$(".cls_form_busca_cliente").hide();
				fn_oculta_errores();
				fn_consulta_cotizacion();


			}
			function fn_nueva_cotizacion()
			{
				$("#fondo_preloader").show();
				$('#id_linea').empty();
				$('#id_sublinea').empty();
				$('#id_marca').empty();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_limpia_cotizacion/",
			        data: {
			        		"id_usuario":"{{id_usuario}}"
			    			},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{
			        		fn_consulta_cotizacion();			        		
			        	}
			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al limpiar la cotización.");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al limpiar la cotización.");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}
			function fn_oculta_errores()
			{
				$("#id_error_linea").hide();
				$("#id_error_tipo_producto").hide();
				$("#id_error_sublinea").hide();
				$("#id_error_marca").hide();
				$("#id_error_avaluo").hide();
				$("#id_error_descripcion").hide();
				$("#id_error_mutuo_sugerido").hide();
				$("#id_error_mutuo_2").hide();
				$("#id_error_mutuo").hide();
				$("#id_error_general").hide();
			}
			function fn_valida_form_cotizacion()
			{
				fn_oculta_errores();

				id_linea=$("#id_linea").val();

				id_tipo_producto=$("#id_tipo_producto").val();
				id_sublinea=$("#id_sublinea").val();
				id_marca=$("#id_marca").val();
				id_descripcion=$("#id_descripcion").val();
				avaluo=$("#id_avaluo").val();
				mutuo_sugerido=$("#id_mutuo_sugerido").val();
				mutuo=$("#id_mutuo").val();
				
				error="1";

				if(id_tipo_producto==null || id_tipo_producto=="")//validamos el select tipo de producto
				{
					$("#id_error_tipo_producto").show();
					error="0";
				}

				if(id_linea==null || id_linea=="")//validamos el select linea
				{
					$("#id_error_linea").show();
					error="0";
				}

				if(id_sublinea==null || id_sublinea=="")//validamos el select sublinea
				{
					$("#id_error_sublinea").show();
					error="0";
				}
			
				if(id_marca==null || id_marca=="")//validamos el select sublinea
				{
					$("#id_error_marca").show();
					error="0";
				}
				if(id_descripcion==null || id_descripcion=="")//validamos el select sublinea
				{
					$("#id_error_descripcion").show();
					error="0";
				}

				if(avaluo==null || avaluo=="" || avaluo<=0)//validamos el select sublinea
				{
					$("#id_error_avaluo").show();
					error="0";
				}

				if(mutuo_sugerido==null || mutuo_sugerido=="" || mutuo_sugerido<=0)//validamos el select sublinea
				{
					$("#id_error_mutuo_sugerido").show();
					error="0";
				}

				if(mutuo==null || mutuo=="" || mutuo<=0)//validamos el select sublinea
				{
					$("#id_error_mutuo").show();
					error="0";
				}


		
				if(parseInt(mutuo)>parseInt(mutuo_sugerido))
				{
					$("#id_error_mutuo_2").show();
					error="0";
				}

				if(error=="0")
				{
					$("#id_error_general").show();
				}
				else
				{
					$("#id_error_general").hide();	
				}
				return error;
			}
			function fn_carga_tipo_producto()
			{
				$("#fondo_preloader").show();
				$('#id_linea').empty();
				$('#id_sublinea').empty();
				$('#id_marca').empty();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_tipo_producto/",
			        data: {},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{
			        		var cont=r[1].lista.length;
			        		$('#id_tipo_producto').empty();
			        		$('#id_tipo_producto').append($('<option>', {
										    value: "",
										    text: "---------------------"
										}));

			        		for (x=0; x<cont;x++)
			        		{
			        			
			        			
									$('#id_tipo_producto').append($('<option>', {
										    value: r[1].lista[x].id_tipo_producto,
										    text: r[1].lista[x].tipo_producto
										}));
			        		}
			        		
			        		$("#fondo_form_emergente").show();
							$(".cls_form_emergente").show();
			        	}
			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al consultar el tipo de Producto.");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al consultar el tipo de Producto.");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}
			function fn_carga_linea(id_tipo_producto)
			{
				$('#id_sublinea').empty();
				$('#id_marca').empty();
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_linea/",
			        data: {"id_tipo_producto":id_tipo_producto},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{
							$('#id_linea').empty();
			        		var cont=r[1].lista.length;
        		        	$('#id_linea').append($('<option>', {
							    value: "",
							    text: "---------------------"
							}));
			        		for (x=0; x<cont;x++)
			        		{
			        			
									$('#id_linea').append($('<option>', {
										    value: r[1].lista[x].id_linea,
										    text: r[1].lista[x].linea
										}));
			        		}

			        	}
			        	if (id_tipo_producto.toString()=="1" || id_tipo_producto.toString()=="2")
			        	{
			        		$("#id_linea").val(id_tipo_producto.toString());
			        		fn_carga_sublinea(id_tipo_producto.toString());
			        			$('#id_linea').prop("disabled",true);
			        		}
			        		else
			        		{
			        			$('#id_linea').prop("disabled",false);
			        		}

			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al cargar el catalogo de Lineas");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al cargar el catalogo de Lineas");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}
			function fn_carga_sublinea(id_linea)
			{
				$('#id_marca').empty();
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_sublinea/",
			        data: {"id_linea":id_linea},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();
							$('#id_sublinea').empty();

			        	}
			        	else//todo correcto
			        	{
							$('#id_sublinea').empty();
			        		var cont=r[1].lista.length;
        		        	$('#id_sublinea').append($('<option>', {
							    value: "",
							    text: "---------------------"
							}));
			        		for (x=0; x<cont;x++)
			        		{
			        			
									$('#id_sublinea').append($('<option>', {
										    value: r[1].lista[x].id_sublinea,
										    text: r[1].lista[x].sublinea
										}));
			        		}

			        	}

			     		if (id_linea.toString()=="1" || id_linea.toString()=="2")
			        	{
			        		$("#id_sublinea").val(id_linea.toString());
			        		fn_carga_marca();
			        			$('#id_sublinea').prop("disabled",true);
			        		}
			        		else
			        		{
			        			$('#id_sublinea').prop("disabled",false);
			        		}


			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al cargar el catalogo de SubLineas");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al cargar el catalogo de SubLineas");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}

			function fn_carga_marca()
			{
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_marcas/",
			        data: {},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{
							$('#id_marca').empty();
			        		var cont=r[1].lista.length;
        		        	$('#id_marca').append($('<option>', {
							    value: "",
							    text: "---------------------"
							}));
			        		for (x=0; x<cont;x++)
			        		{
			        			
									$('#id_marca').append($('<option>', {
										    value: r[1].lista[x].id_marca,
										    text: r[1].lista[x].marca
										}));
			        		}

			        		if ($("#id_tipo_producto").val()=="1" || $("#id_tipo_producto").val()=="2")
			        		{
			        			$('#id_marca').val("1");
			        			$('#id_marca').prop("disabled",true);
			        		}
			        		else
			        		{
			        			$('#id_marca').prop("disabled",false);
			        		}


			        	}
			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al cargar el catalogo de marcas");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al cargar el catalogo de marcas");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}


			function fn_carga_kilataje(id_tipo_producto)
			{
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_kilataje/",
			        data: {"id_tipo_producto":id_tipo_producto},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{
							$('#id_kilataje').empty();
			        		var cont=r[1].lista.length;
        		        	$('#id_kilataje').append($('<option>', {
							    value: "",
							    text: "---------------------"
							}));
			        		for (x=0; x<cont;x++)
			        		{
			        			
									$('#id_kilataje').append($('<option>', {
										    value: r[1].lista[x].id_kilataje,
										    text: r[1].lista[x].kilataje
										}));
			        		}

			        	}
			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al consultar el catalogo de kilatajes");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al consultar el catalogo de kilatajes");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}

			function fn_consulta_costo_kilataje(id_kilataje)
			{
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_costo_kilataje/",
			        data: {"id_kilataje":id_kilataje},
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{

			        		var avaluo=r[1].costo;
			        		var peso=$("#id_peso").val();
			        		var total_avaluo=avaluo*peso;

			        		$("#id_avaluo").val(parseFloat(total_avaluo).toFixed(0));
			        		$("#id_mutuo_sugerido").val(parseFloat(total_avaluo*0.81).toFixed(0));
			        		$("#id_mutuo").val(parseFloat(total_avaluo*0.81).toFixed(0));
			        		if (mutuo_aux>0)
			        		{
			        			$("#id_mutuo").val(mutuo_aux);
			        		}

			        	}
			        	$("#fondo_preloader").hide();
			        	fn_valida_form_cotizacion();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al consultar el costo del kilataje");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al consultar el costo del kilataje");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});
			}

			function  fn_calcula_totales()
			{
				var id_tipo_producto=$("#id_tipo_producto").val();
				//si es oro o plata
				if(id_tipo_producto==1 || id_tipo_producto==2)
				{
					var id_kilataje= $("#id_kilataje").val();
					if (id_kilataje!="")
					{
						fn_consulta_costo_kilataje($("#id_kilataje").val());
						//cuando sea articulos varios el avaluo es editable						
						$("#id_peso").prop("disabled",false);
					}
					else
					{
						$("#id_peso").val("0");
						$("#id_peso").prop("disabled",true);
						$("#id_mutuo_sugerido").val("0");
						$("#id_avaluo").val("0");
						$("#id_mutuo").val("0");
					}
					$("#id_avaluo").prop("readonly",true);	
					
				}
				else//si es articulos varios
				{	
					var avaluo=$("#id_avaluo").val();

					$("#id_mutuo_sugerido").val(parseFloat(avaluo*0.65).toFixed(0));
					$("#id_mutuo").val(parseFloat(avaluo*0.65).toFixed(0));
					if (mutuo_aux>0)
	        		{
	        			$("#id_mutuo").val(mutuo_aux);
	        		}
					
				}
			}

			function fn_guarda_cotizacion()
			{
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_guarda_producto_temporal/",
			        data: {

						"id_usuario":"{{id_usuario}}",
						"id_tipo_producto":$("#id_tipo_producto").val(),
						"id_linea":$("#id_linea").val(),
						"id_sublinea":$("#id_sublinea").val(),
						"id_marca":$("#id_marca").val(),
						"descripcion":$("#id_descripcion").val(),
						"id_kilataje":$("#id_kilataje").val(),
						"peso":$("#id_peso").val(),
						"avaluo":$("#id_avaluo").val(),
						"mutuo_sugerido":$("#id_mutuo_sugerido").val(),
						"mutuo":$("#id_mutuo").val(),
						"observaciones":$("#txt_observaciones").val()

			        },
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{

			        		$("#fondo_form_emergente").hide();
							$(".cls_form_emergente").hide();

			        	}

			        	$("#fondo_preloader").hide();
			        	fn_consulta_cotizacion();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al guardar la cotizacion");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al guardar la cotizacion");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});

			}


			function fn_consulta_cotizacion()
			{
				$("#tabla_cotizacion tbody tr").remove();
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_cotizacion/",
			        data: {

						"id_usuario":"{{id_usuario}}"

			        },
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{

			        		fn_agregarFila(r[1].lista);
			        		
			        		$("#num_movs").text(r[3].cont_movs);

			        	}
						
						
			        	$("#fondo_preloader").hide();

			        	if($("#id_plazo").val()!="")
			        	{
			        		$("#id_avaluo_oro").text("$"+r[2].avaluo_oro.toString()+".00");
							$("#id_avaluo_plata").text("$"+r[2].avaluo_plata.toString()+".00");
							$("#id_avaluo_varios").text("$"+r[2].avaluo_varios.toString()+".00");

							$("#id_mutuo_oro").text("$"+r[2].mutuo_oro.toString()+".00");
							$("#id_mutuo_plata").text("$"+r[2].mutuo_plata.toString()+".00");
							$("#id_mutuo_varios").text("$"+r[2].mutuo_varios.toString()+".00");

							$("#id_refrendo_oro").text("$"+r[2].refrendo_oro.toString()+".00");
							$("#id_refrendo_plata").text("$"+r[2].refrendo_plata.toString()+".00");
							$("#id_refrendo_varios").text("$"+r[2].refrendo_varios.toString()+".00");


							
			        	}
			        	else
			        	{


							$("#id_avaluo_oro").text("$0.00");
							$("#id_avaluo_plata").text("$0.00");
							$("#id_avaluo_varios").text("$0.00");

							$("#id_mutuo_oro").text("$0.00");
							$("#id_mutuo_plata").text("$0.00");
							$("#id_mutuo_varios").text("$0.00");

							$("#id_refrendo_oro").text("$0.00");
							$("#id_refrendo_plata").text("$0.00");
							$("#id_refrendo_varios").text("$0.00");
				

			        	}
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al consultar la cotizacion");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al consultarconsultar la cotizacion");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});

			}

			function fn_busca_cliente()
			{
				$("#tabla_cliente tbody tr").remove();
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_consulta_cliente/",
			        data: {

						"palabra":$("#id_cliente_nomapp").val()

			        },
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{

			        		fn_agregarFila_cliente(r[1].lista);

			        	}

			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al consultar el cliente");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		 $("#msj_error").text("Error al consultar el cliente");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});

			}
			function fn_agregarFila_cliente(obj)
			{
   				var cont=obj.length;

   				for(x=0; x<cont;x++)
   				{
   					var htmlTags = '<tr>'+

				        "<td><a onClick='fn_seleccionar_cliente("+obj[x].id.toString()+")' class='btn btn-default btn-sm'><span class='glyphicon glyphicon-ok'></span>    					</a> 			</td>"+
				        '<td>' + obj[x].nombre + '</td>'+
				      '</tr>';
			      
			  	 	$('#tabla_cliente tbody').append(htmlTags);
   				}

			}
			function fn_seleccionar_cliente(id)
			{
				$("#id_cliente").val(id.toString());
				$(".cls_form_busca_cliente").hide();		
				$("#fondo_form_emergente").hide();
			}
			function fn_agregarFila(obj) {
   				var cont=obj.length;
   				for(x=0; x<cont;x++)
   				{
   				var htmlTags = '<tr>'+

			        "<td><a onClick='fn_elimnar_producto("+obj[x].id.toString()+")' class='btn btn-default btn-sm'><span class='glyphicon glyphicon-remove'></span>    					</a> 			</td>"+
			        '<td>' + obj[x].tipo_producto + '</td>'+
			        '<td>' + obj[x].linea + '</td>'+
			        '<td>' + obj[x].sub_linea + '</td>'+
			        '<td>' + obj[x].marca + '</td>'+
			        '<td>' + obj[x].descripcion + '</td>'+
			        '<td>' + obj[x].Kilataje + '</td>'+
			        '<td>' + obj[x].peso + '</td>'+
			        '<td>' + obj[x].avaluo + '</td>'+
			        '<td>' + obj[x].mutuo_sugerido + '</td>'+
			        '<td>' + obj[x].mutuo + '</td>'+
			        
			
			      '</tr>';
			      
			   $('#tabla_cotizacion tbody').append(htmlTags);
   				}


			}
			function fn_elimnar_producto(id)
			{
				producto_eliminar=id;
				$(".cls_confirma_eliminar").show();
			}
			function fn_confirma_eliminar_producto()
			{
				
				$("#fondo_preloader").show();
				$.ajax({
					type: "GET",
			        url: "{{IP_LOCAL}}/empenos/api_elimina_producto_cotizacion/",
			        data: {

						"id_producto":producto_eliminar

			        },
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function (r) {
			        	
			        	//fallo
			        	if (r[0].estatus=="0")
			        	{
			        		$("#msj_error").text(r[0].msj);

							$(".cls_msj_error").show();

			        	}
			        	else//todo correcto
			        	{

			        		fn_consulta_cotizacion();

			        	}

			        	$("#fondo_preloader").hide();
			        },
			        error: function (r) {
			        		$("#msj_error").text("Error al eliminar el producto");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        },
			        failure: function (r) {
			        		$("#msj_error").text("Error al eliminar el producto");
							$(".cls_msj_error").show();
							$("#fondo_preloader").hide();
			        }
				});

			}
//**********************************************************************************************
//**********************************************************************************************
	</script>

{% endblock %}
